name: Deploy to Staging

on:
  push:
    branches:
      - develop

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Setup SSH Keys and Config
        run: |
          mkdir -p ~/.ssh
          
          # Salva le chiavi
          echo "${{ secrets.BASTION_SSH_KEY }}" > ~/.ssh/bastion_key
          echo "${{ secrets.STAGING_SSH_KEY }}" > ~/.ssh/staging_key
          chmod 600 ~/.ssh/bastion_key ~/.ssh/staging_key
          
          # Configura SSH
          cat >> ~/.ssh/config <<EOF
          Host bastion
            HostName ${{ secrets.BASTION_IP }}
            User ${{ secrets.BASTION_USER }}
            Port 22
            IdentityFile ~/.ssh/bastion_key
            StrictHostKeyChecking no
            UserKnownHostsFile=/dev/null
          
          Host staging
            HostName ${{ secrets.STAGING_IP }}
            User ${{ secrets.STAGING_USER }}
            Port 22
            IdentityFile ~/.ssh/staging_key
            ProxyJump bastion
            StrictHostKeyChecking no
            UserKnownHostsFile=/dev/null
          EOF
          
          # Mostra config per debug (senza dati sensibili)
          echo "SSH config created"
          
      - name: Test SSH Connection
        run: |
          echo "Testing connection to staging through bastion..."
          ssh staging "echo 'Connection successful!'"
      
      - name: Deploy to Staging
        run: |
          ssh staging << 'ENDSSH'
            set -e
            echo "ðŸš€ Starting deployment to STAGING..."
            echo "Current user: $(whoami)"
            echo "Current directory: $(pwd)"
            
            cd /var/www/app-staging
            
            echo "ðŸ“¦ Pulling latest code from develop branch..."
            git fetch origin
            git reset --hard origin/dev
            
            echo "ðŸ“¥ Installing dependencies..."
            npm ci --production
            
            echo "ðŸ—„ï¸  Database migrations (if needed)..."
            # npm run migrate
            
            echo "â™»ï¸  Restarting PM2 process..."
            pm2 restart app-staging --update-env
            
            echo "â³ Waiting for app to start..."
            sleep 3
            
            echo "âœ… Deployment completed!"
            pm2 list
            pm2 logs app-staging --lines 10 --nostream
          ENDSSH
      
      - name: Verify Deployment
        run: |
          ssh staging "pm2 list | grep app-staging | grep online || exit 1"
          echo "âœ… Staging is running!"
