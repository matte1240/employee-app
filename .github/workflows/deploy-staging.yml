name: Deploy to Staging

on:
  push:
    branches:
      - dev
  
  workflow_dispatch:

jobs:
  build_and_push:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile
          push: true
          tags: |
            ghcr.io/${{ github.repository_owner }}/employee-app:latest
            ghcr.io/${{ github.repository_owner }}/employee-app:staging-${{ github.sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
  
  deploy:
    runs-on: ubuntu-latest
    needs: build_and_push
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup SSH Keys and Config
        run: |
          mkdir -p ~/.ssh
          
          # Salva le chiavi
          echo "${{ secrets.BASTION_SSH_KEY }}" > ~/.ssh/bastion_key
          echo "${{ secrets.STAGING_SSH_KEY }}" > ~/.ssh/staging_key
          chmod 600 ~/.ssh/bastion_key ~/.ssh/staging_key
          
          # Configura SSH
          cat >> ~/.ssh/config <<EOF
          Host bastion
            HostName ${{ secrets.BASTION_IP }}
            User ${{ secrets.BASTION_USER }}
            Port 22
            IdentityFile ~/.ssh/bastion_key
            StrictHostKeyChecking no
            UserKnownHostsFile=/dev/null
          
          Host staging
            HostName ${{ secrets.STAGING_IP }}
            User ${{ secrets.STAGING_USER }}
            Port 22
            IdentityFile ~/.ssh/staging_key
            ProxyJump bastion
            StrictHostKeyChecking no
            UserKnownHostsFile=/dev/null
          EOF
          
          # Mostra config per debug (senza dati sensibili)
          echo "SSH config created"
          
      - name: Test SSH Connection
        run: |
          echo "Testing connection to staging through bastion..."
          ssh staging "echo 'Connection successful!'"
      
      - name: Prepare remote directory
        run: |
          ssh staging "mkdir -p ~/development-webapp"

      - name: Copy docker-compose file
        run: |
          scp docker-compose.yml staging:~/development-webapp/docker-compose.yml

      - name: Ensure log/backup directories
        run: |
          ssh staging "mkdir -p ~/development-webapp/logs ~/development-webapp/backups/database && chmod 775 ~/development-webapp/logs ~/development-webapp/backups ~/development-webapp/backups/database"
      
      - name: Deploy to Staging with Docker
        run: |
          ssh staging "DATABASE_URL='${{ secrets.STAGING_DATABASE_URL }}' NEXTAUTH_SECRET='${{ secrets.STAGING_NEXTAUTH_SECRET }}' NEXTAUTH_URL='${{ secrets.STAGING_NEXTAUTH_URL }}' EMAIL_HOST='${{ secrets.EMAIL_HOST }}' EMAIL_PORT='${{ secrets.EMAIL_PORT }}' EMAIL_USER='${{ secrets.EMAIL_USER }}' EMAIL_PASSWORD='${{ secrets.EMAIL_PASSWORD }}' EMAIL_FROM_NAME='${{ secrets.EMAIL_FROM_NAME }}' GITHUB_TOKEN='${{ secrets.GH_PAT }}' bash -s" <<'ENDSSH'
            set -e
            
            echo "ğŸš€ Starting Docker deployment to STAGING..."
            echo "Current user: $(whoami)"
            HOME_DIR="${HOME:-/home/${USER:-runner}}"
            if [ -z "$HOME_DIR" ] || [ "$HOME_DIR" = "/" ]; then
              derived_home="$(getent passwd "$(whoami)" | cut -d: -f6)"
              if [ -n "$derived_home" ]; then
                HOME_DIR="$derived_home"
              fi
            fi
            APP_DIR="${HOME_DIR%/}/development-webapp"
            if [ -z "$APP_DIR" ] || [ "$APP_DIR" = "/development-webapp" ]; then
              echo "Unable to determine application directory path." >&2
              exit 1
            fi
            if [ ! -f "$APP_DIR/docker-compose.yml" ]; then
              echo "docker-compose.yml not found in $APP_DIR" >&2
              exit 1
            fi
            cd "$APP_DIR" || { echo "Failed to cd to $APP_DIR"; exit 1; }
            
            echo "ğŸ“‚ Using directory: $(pwd)"
            
            echo "ğŸ” Creating .env file for Docker Compose..."
            {
              echo "DATABASE_URL=${DATABASE_URL}"
              echo "NEXTAUTH_SECRET=${NEXTAUTH_SECRET}"
              echo "NEXTAUTH_URL=${NEXTAUTH_URL}"
              echo "EMAIL_HOST=${EMAIL_HOST}"
              echo "EMAIL_PORT=${EMAIL_PORT}"
              echo "EMAIL_USER=${EMAIL_USER}"
              echo "EMAIL_PASSWORD=${EMAIL_PASSWORD}"
              echo "EMAIL_FROM_NAME=${EMAIL_FROM_NAME}"
              echo "APP_URL=${NEXTAUTH_URL}"
              echo "APP_PORT=3001"
            } > .env
            
            echo "ğŸ³ Logging into GitHub Container Registry..."
            echo "${GITHUB_TOKEN}" | docker login ghcr.io -u matte1240 --password-stdin
            
            echo "ğŸ“¥ Pulling latest Docker image..."
            docker pull ghcr.io/matte1240/employee-app:latest
            
            echo "ğŸ›‘ Stopping existing containers..."
            docker compose down || true
            
            echo "ğŸš€ Starting application container (database esterno)..."
            docker compose up -d app
            
            echo "â³ Waiting for application to start..."
            sleep 5
            
            echo "ğŸ“Š Checking container status..."
            docker compose ps
            
            echo "ğŸ“‹ Application logs (last 20 lines)..."
            docker compose logs --tail=20 app
            
            echo "âœ… Docker deployment completed!"
          ENDSSH
      
      - name: Verify Deployment
        run: |
          ssh staging "cd ~/development-webapp && docker compose ps | grep employee-tracker-app | grep Up || exit 1"
          echo "âœ… Staging is running!"
