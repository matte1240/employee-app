name: Cache Cleanup

on:
  workflow_dispatch:
    inputs:
      cache_key_pattern:
        description: 'Pattern to match cache keys (e.g., * for all)'
        required: false
        default: '*'
        type: string
      older_than_days:
        description: 'Delete caches older than X days'
        required: false
        default: '1'
        type: string

jobs:
  cleanup:
    runs-on: ubuntu-latest
    permissions:
      actions: write
      contents: read
      
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        
      - name: Cleanup caches
        run: |
          echo "Cleaning up GitHub Actions caches..."
          
          # Get all cache keys matching the pattern
          CACHE_KEYS=$(gh cache list --repo ${{ github.repository }} --key "${{ inputs.cache_key_pattern }}" --json key,createdAt --jq '.[].key')
          
          if [ -z "$CACHE_KEYS" ]; then
            echo "No caches found matching pattern: ${{ inputs.cache_key_pattern }}"
            exit 0
          fi
          
          echo "Found caches:"
          echo "$CACHE_KEYS"
          
          # Calculate cutoff date
          if [ "${{ inputs.older_than_days }}" != "0" ]; then
            CUTOFF_DATE=$(date -d "${{ inputs.older_than_days }} days ago" +%Y-%m-%dT%H:%M:%SZ 2>/dev/null || date -v -${{ inputs.older_than_days }}d +%Y-%m-%dT%H:%M:%SZ)
            echo "Deleting caches older than: $CUTOFF_DATE"
            
            # Get cache IDs to delete
            CACHE_IDS=$(gh cache list --repo ${{ github.repository }} --key "${{ inputs.cache_key_pattern }}" --json id,createdAt --jq ".[] | select(.createdAt < \"$CUTOFF_DATE\") | .id")
          else
            # Delete all matching caches
            CACHE_IDS=$(gh cache list --repo ${{ github.repository }} --key "${{ inputs.cache_key_pattern }}" --json id --jq '.[].id')
          fi
          
          if [ -z "$CACHE_IDS" ]; then
            echo "No caches to delete"
            exit 0
          fi
          
          echo "Deleting cache IDs: $CACHE_IDS"
          
          # Delete each cache
          echo "$CACHE_IDS" | while read -r id; do
            if [ -n "$id" ]; then
              echo "Deleting cache ID: $id"
              gh cache delete --repo ${{ github.repository }} "$id"
            fi
          done
          
          echo "Cache cleanup completed!"
        env:
          GH_TOKEN: ${{ github.token }}
          
      - name: Summary
        run: |
          echo "### ðŸ§¹ Cache Cleanup Completed!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Pattern:** \`${{ inputs.cache_key_pattern }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Older than:** ${{ inputs.older_than_days }} days" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Check the logs above for details on deleted caches." >> $GITHUB_STEP_SUMMARY