"use client";

import { useEffect, useMemo, useRef, useState, useTransition } from "react";
import {
  addMonths,
  eachDayOfInterval,
  endOfMonth,
  format,
  isSameDay,
  isSameMonth,
  parseISO,
  startOfMonth,
  startOfWeek,
  endOfWeek,
} from "date-fns";
import { useRouter } from "next/navigation";

export type TimeEntryDTO = {
  id: string;
  workDate: string;
  hoursWorked: number;
  overtimeHours?: number;
  morningStart?: string | null;
  morningEnd?: string | null;
  afternoonStart?: string | null;
  afternoonEnd?: string | null;
  notes?: string | null;
};

type EmployeeDashboardProps = {
  initialEntries: TimeEntryDTO[];
  userName: string;
};

type ModalFormState = {
  morningStart: string;
  morningEnd: string;
  afternoonStart: string;
  afternoonEnd: string;
  notes: string;
};

export default function EmployeeDashboard({
  initialEntries,
  userName,
}: EmployeeDashboardProps) {
  const router = useRouter();
  const [currentMonth, setCurrentMonth] = useState(() => startOfMonth(new Date()));
  const [entries, setEntries] = useState<TimeEntryDTO[]>(initialEntries);
  const [isFetching, setIsFetching] = useState(false);
  const [error, setError] = useState<string | null>(null);
  const [isSaving, startSaving] = useTransition();
  const hasFetched = useRef(false);

  // Modal state
  const [isModalOpen, setIsModalOpen] = useState(false);
  const [selectedDate, setSelectedDate] = useState<string | null>(null);
  const [modalError, setModalError] = useState<string | null>(null);
  const [modalForm, setModalForm] = useState<ModalFormState>({
    morningStart: "09:00",
    morningEnd: "13:00",
    afternoonStart: "14:00",
    afternoonEnd: "18:00",
    notes: "",
  });

  useEffect(() => {
    if (!hasFetched.current) {
      hasFetched.current = true;
      return;
    }

    const controller = new AbortController();
    const fetchEntries = async () => {
      setIsFetching(true);
      setError(null);
      try {
        const from = format(startOfMonth(currentMonth), "yyyy-MM-dd");
        const to = format(endOfMonth(currentMonth), "yyyy-MM-dd");
        const response = await fetch(`/api/hours?from=${from}&to=${to}`, {
          signal: controller.signal,
        });

        if (response.status === 401) {
          router.push("/");
          return;
        }

        const payload = await response.json();

        if (!response.ok) {
          setError(payload?.error ?? "Failed to load entries.");
          return;
        }

        setEntries(payload as TimeEntryDTO[]);
      } catch (err) {
        if ((err as Error).name !== "AbortError") {
          setError("Unexpected error while loading entries.");
        }
      } finally {
        setIsFetching(false);
      }
    };

    fetchEntries();

    return () => controller.abort();
  }, [currentMonth, router]);

  const entriesByDay = useMemo(() => {
    const map = new Map<string, TimeEntryDTO[]>();
    for (const entry of entries) {
      const key = format(parseISO(entry.workDate), "yyyy-MM-dd");
      const bucket = map.get(key) ?? [];
      bucket.push(entry);
      map.set(key, bucket);
    }

    for (const [, bucket] of map) {
      bucket.sort((a, b) => parseISO(a.workDate).getTime() - parseISO(b.workDate).getTime());
    }

    return map;
  }, [entries]);

  const calendarDays = useMemo(() => {
    const start = startOfWeek(startOfMonth(currentMonth), { weekStartsOn: 1 });
    const end = endOfWeek(endOfMonth(currentMonth), { weekStartsOn: 1 });
    return eachDayOfInterval({ start, end });
  }, [currentMonth]);

  const totalHours = useMemo(
    () => entries.reduce((sum, entry) => sum + entry.hoursWorked, 0),
    [entries]
  );

  // Check if the selected date is within editable range (current month, up to today)
  const isDateEditable = useMemo(() => {
    const selectedDate = new Date(`${formState.workDate}T00:00:00.000Z`);
    const today = new Date();
    today.setUTCHours(0, 0, 0, 0);
    const currentMonthStart = new Date(today.getUTCFullYear(), today.getUTCMonth(), 1);

    return selectedDate >= currentMonthStart && selectedDate <= today;
  }, [formState.workDate]);

  const handleCreateEntry = (event: React.FormEvent<HTMLFormElement>) => {
    event.preventDefault();
    setFormError(null);

    if (!isDateEditable) {
      setFormError("Can only enter hours for the current month up to today.");
      return;
    }

    const payload = {
      workDate: formState.workDate,
      hoursWorked: Number(formState.hoursWorked),
      notes: formState.notes.trim() ? formState.notes.trim() : undefined,
    };

    if (Number.isNaN(payload.hoursWorked)) {
      setFormError("Hours must be a number.");
      return;
    }

    if (payload.hoursWorked < 0 || payload.hoursWorked > 24) {
      setFormError("Hours must be between 0 and 24.");
      return;
    }

    startSaving(async () => {
      try {
        const response = await fetch("/api/hours", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload),
        });

        const data = await response.json();

        if (!response.ok) {
          setFormError(data?.error ?? "Unable to save entry.");
          return;
        }

        setEntries((current) => [...current, data as TimeEntryDTO]);
        setFormState((state) => ({ ...state, hoursWorked: "8", notes: "" }));
        router.refresh();
      } catch {
        setFormError("Unexpected error while saving entry.");
      }
    });
  };

  return (
    <div className="flex flex-col gap-8">
      <header className="flex flex-col gap-2">
        <h1 className="text-3xl font-semibold text-zinc-900">
          Welcome, {userName.split(" ")[0] ?? userName}
        </h1>
        <p className="text-sm text-zinc-500">
          Track your work hours, review progress, and keep your manager up to date.
        </p>
        <p className="text-sm font-medium text-zinc-600">
          Month total: <span className="font-semibold text-blue-600">{totalHours.toFixed(1)}</span> hrs
        </p>
      </header>

      <section className="grid gap-6 lg:grid-cols-[2fr_1fr]">
        <div className="rounded-2xl border border-zinc-200 bg-white p-6 shadow-sm">
          <div className="mb-4 flex items-center justify-between">
            <div>
              <h2 className="text-lg font-semibold text-zinc-800">
                {format(currentMonth, "MMMM yyyy")}
              </h2>
              {isFetching ? (
                <p className="text-xs text-zinc-500">Refreshing calendar...</p>
              ) : null}
              {error ? (
                <p className="text-xs text-red-500">{error}</p>
              ) : null}
            </div>
            <div className="flex items-center gap-2">
              <button
                type="button"
                onClick={() => setCurrentMonth((month) => addMonths(month, -1))}
                className="flex h-9 w-9 items-center justify-center rounded-full border border-zinc-200 text-zinc-600 transition hover:border-blue-200 hover:text-blue-600"
              >
                &lt;
              </button>
              <button
                type="button"
                onClick={() => setCurrentMonth(() => startOfMonth(new Date()))}
                className="flex h-9 items-center justify-center rounded-full border border-transparent px-3 text-sm font-medium text-blue-600 transition hover:border-blue-200 hover:bg-blue-50"
              >
                Today
              </button>
              <button
                type="button"
                onClick={() => setCurrentMonth((month) => addMonths(month, 1))}
                className="flex h-9 w-9 items-center justify-center rounded-full border border-zinc-200 text-zinc-600 transition hover:border-blue-200 hover:text-blue-600"
              >
                &gt;
              </button>
            </div>
          </div>

          <div className="grid grid-cols-7 gap-2 text-center text-xs font-semibold uppercase tracking-wide text-zinc-400">
            {["Mon", "Tue", "Wed", "Thu", "Fri", "Sat", "Sun"].map((day) => (
              <div key={day}>{day}</div>
            ))}
          </div>

          <div className="mt-2 grid grid-cols-7 gap-2">
            {calendarDays.map((day) => {
              const key = format(day, "yyyy-MM-dd");
              const bucket = entriesByDay.get(key);
              const totalForDay = bucket?.reduce((sum, item) => sum + item.hoursWorked, 0) ?? 0;
              const hasEntries = Boolean(bucket && bucket.length);
              const highlight = isSameDay(day, new Date());

              return (
                <div
                  key={key}
                  className={`flex min-h-[86px] flex-col rounded-xl border p-2 text-left text-xs transition ${
                    isSameMonth(day, currentMonth)
                      ? "border-zinc-200 bg-white"
                      : "border-dashed border-zinc-200 bg-zinc-50 text-zinc-400"
                  } ${
                    highlight ? "ring-2 ring-blue-200" : ""
                  }`}
                >
                  <div className="flex items-center justify-between text-[11px] font-medium text-zinc-500">
                    <span>{format(day, "d")}</span>
                    {hasEntries ? (
                      <span className="rounded-full bg-blue-50 px-2 py-0.5 text-[10px] font-semibold text-blue-600">
                        {totalForDay.toFixed(1)}h
                      </span>
                    ) : null}
                  </div>
                  {hasEntries ? (
                    <ul className="mt-1 space-y-1 text-[11px] text-zinc-500">
                      {bucket!.map((entry) => (
                        <li key={entry.id} className="truncate">
                          {entry.hoursWorked.toFixed(1)}h
                          {entry.notes ? ` Â· ${entry.notes}` : ""}
                        </li>
                      ))}
                    </ul>
                  ) : (
                    <div className="mt-auto text-[10px] text-zinc-300">No entry</div>
                  )}
                </div>
              );
            })}
          </div>
        </div>

        <div className="flex flex-col gap-6">
          <form
            onSubmit={handleCreateEntry}
            className="flex flex-col gap-4 rounded-2xl border border-zinc-200 bg-white p-6 shadow-sm"
          >
            <div>
              <h2 className="text-lg font-semibold text-zinc-800">Log hours</h2>
              <p className="text-xs text-zinc-500">Add a quick summary of today&apos;s work.</p>
            </div>
            <label className="flex flex-col gap-2 text-xs font-medium text-zinc-600">
              Date
              <input
                type="date"
                required
                value={formState.workDate}
                onChange={(event) =>
                  setFormState((state) => ({ ...state, workDate: event.target.value }))
                }
                className="rounded-lg border border-zinc-200 bg-white px-3 py-2 text-sm shadow-sm outline-none transition focus:border-blue-400 focus:ring-2 focus:ring-blue-200"
              />
            </label>
            <label className="flex flex-col gap-2 text-xs font-medium text-zinc-600">
              Hours worked
              <input
                type="number"
                step="0.25"
                min="0"
                max="24"
                required
                value={formState.hoursWorked}
                onChange={(event) =>
                  setFormState((state) => ({ ...state, hoursWorked: event.target.value }))
                }
                className="rounded-lg border border-zinc-200 bg-white px-3 py-2 text-sm shadow-sm outline-none transition focus:border-blue-400 focus:ring-2 focus:ring-blue-200"
              />
            </label>
            <label className="flex flex-col gap-2 text-xs font-medium text-zinc-600">
              Notes
              <textarea
                value={formState.notes}
                onChange={(event) =>
                  setFormState((state) => ({ ...state, notes: event.target.value }))
                }
                placeholder="Highlight your main accomplishments."
                rows={3}
                className="rounded-lg border border-zinc-200 bg-white px-3 py-2 text-sm shadow-sm outline-none transition focus:border-blue-400 focus:ring-2 focus:ring-blue-200"
              />
            </label>
            {formError ? <p className="text-xs text-red-500">{formError}</p> : null}
            {!isDateEditable && !formError ? (
              <p className="text-xs text-yellow-600">
                You can only enter hours for the current month up to today.
              </p>
            ) : null}
            <button
              type="submit"
              disabled={isSaving || !isDateEditable}
              className="flex h-10 items-center justify-center rounded-lg bg-blue-600 text-sm font-semibold text-white transition hover:bg-blue-500 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-blue-600 disabled:cursor-not-allowed disabled:bg-blue-300"
            >
              {isSaving ? "Saving..." : "Save entry"}
            </button>
          </form>

          <section className="rounded-2xl border border-zinc-200 bg-white p-6 shadow-sm">
            <h2 className="text-lg font-semibold text-zinc-800">Recent entries</h2>
            <ul className="mt-4 space-y-3 text-sm text-zinc-600">
              {entries
                .slice()
                .sort(
                  (a, b) => parseISO(b.workDate).getTime() - parseISO(a.workDate).getTime()
                )
                .slice(0, 8)
                .map((entry) => (
                  <li key={entry.id} className="flex items-center justify-between gap-4">
                    <div>
                      <p className="font-medium text-zinc-700">
                        {format(parseISO(entry.workDate), "EEEE, MMM d")}
                      </p>
                      {entry.notes ? (
                        <p className="text-xs text-zinc-500">{entry.notes}</p>
                      ) : null}
                    </div>
                    <span className="text-sm font-semibold text-blue-600">
                      {entry.hoursWorked.toFixed(1)} h
                    </span>
                  </li>
                ))}
            </ul>
          </section>
        </div>
      </section>
    </div>
  );
}
